#!/bin/sh

f=`basename $0`
subtask=${f%.sh}

. ./optparams.sh

if [ $# -eq 1 ] 
then
    echo "Input: "$1
else
    echo "Error!! Format is: $f <Airport_Code>"
    exit 1
fi

echo "............................................................................................... "
echo "          2.1 Airport:(Airline, Average delay in minutes)"
echo "............................................................................................... "

echo "............................................................................................... "
echo "          1/3. Execute Hadoop job"
echo "............................................................................................... "


hadoop jar ../jars/${subtask}.jar airline/stage ${subtask} $1 $HDP_OPTS

echo "............................................................................................... "
echo "          2/3. Output"
echo "............................................................................................... "

mkdir -p ../results
hadoop fs -getmerge ${subtask} ../results/${subtask}.csv
cat ../results/${subtask}.csv

echo "............................................................................................... "
echo "          3/4. Storing results in Cassandra"
echo "............................................................................................... "

cqlsh -f ../cqls/${subtask}_setup.cql
cqlsh -f ../cqls/${subtask}_save.cql

echo "............................................................................................... "
echo "          4/4. Output results from Cassandra"
echo "............................................................................................... "

cqlsh -e "SELECT carrier FROM airline.airport_carrier where origin=$1";

echo "............................................................................................... "
echo "          Done"
echo "............................................................................................... "
