#!/bin/sh

f=`basename $0`
subtask=${f%.sh}
base=`dirname $0`/..
#echo $base

. ./optparams.sh

if [ $# -eq 1 ] 
then
    echo "Input: "$1
else
    echo "Error!! Format is: $f <Airport_Code>"
    exit 1
fi

echo "............................................................................................... "
echo "          2.2 Airport:(Airport, Average delay in minutes)"
echo "............................................................................................... "

echo "............................................................................................... "
echo "          1/4. Execute Hadoop job"
echo "............................................................................................... "

hadoop jar ${base}/jars/${subtask}.jar airline/stage ${subtask} $1 $HDP_OPTS

echo "............................................................................................... "
echo "          2/4. Raw Output"
echo "............................................................................................... "

mkdir -p ${base}/results
hadoop fs -getmerge ${subtask} ${base}/results/${subtask}.csv
cat ${base}/results/${subtask}.csv

echo "............................................................................................... "
echo "          3/4. Storing results in Cassandra"
echo "............................................................................................... "

cqlsh -f ${base}/cqls/${subtask}_setup.cql
cqlsh -f ${base}/cqls/${subtask}_save.cql

echo "............................................................................................... "
echo "          4/4. Output results from Cassandra"
echo "............................................................................................... "

cqlsh -e "SELECT destination,depdelay FROM airline.airport_destination WHERE airport='${1}'";

echo "............................................................................................... "
echo "          Done"
echo "............................................................................................... "
