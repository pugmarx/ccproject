#!/bin/sh

f=`basename $0`
subtask=${f%.sh}
base=`dirname $0`/..
#echo $base

. ./optparams.sh

if [ $# -eq 2 ] 
then
    echo "Input: "$1,$2
else
    echo "Error!! Format is: $f <Origin_Code> <Dest_Code>"
    exit 1
fi

echo "............................................................................................... "
echo "          2.4 X -> Y: Average delay in minutes"
echo "............................................................................................... "

echo "............................................................................................... "
echo "          1/4. Execute Hadoop job"
echo "............................................................................................... "

hadoop jar ${base}/jars/${subtask}.jar airline/stage ${subtask} $1 $2 $HDP_OPTS

echo "............................................................................................... "
echo "          2/4. Raw Output"
echo "............................................................................................... "

mkdir -p ${base}/results
hadoop fs -getmerge ${subtask} ${base}/results/${subtask}.csv
cat ${base}/results/${subtask}.csv

echo "............................................................................................... "
echo "          3/4. Storing results in Cassandra"
echo "............................................................................................... "

cqlsh -f ${base}/cqls/${subtask}_setup.cql
cqlsh -f ${base}/cqls/${subtask}_save.cql

echo "............................................................................................... "
echo "          4/4. Output results from Cassandra"
echo "............................................................................................... "

cqlsh -e "SELECT * FROM airline.airport_dest_delay WHERE airport='${1}' and destination='${2}'";

echo "............................................................................................... "
echo "          Done"
echo "............................................................................................... "
